# Bandgap prediction Linear Regression

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import mean_squared_error, r2_score
from mp_api.client import MPRester
from pymatgen.core import Structure
import traceback

# Function to log messages
def log_message(message):
    print(message)
    with open("log.txt", "a") as log_file:
        log_file.write(message + "\n")

try:
    # Step 1: Fetch data from Materials Project
    API_KEY = "OccTsh7pOXkXsjf2974ZlkObXb1jeuNF"
    mpr = MPRester(API_KEY)

    log_message("Fetching data from Materials Project...")
    results = mpr.materials.summary.search(band_gap=(0.1, 3), fields=["material_id", "band_gap", "structure", "formula_pretty"])
    log_message(f"Fetched {len(results)} entries.")

    # Step 2: Extract features from structures
    def extract_features_from_structure(structure):
        try:
            return {
                "mean_atomic_numbers": np.mean(structure.atomic_numbers),
                "max_atomic_numbers": np.max(structure.atomic_numbers),
                "min_atomic_numbers": np.min(structure.atomic_numbers),
                "std_atomic_numbers": np.std(structure.atomic_numbers),
                "a_parameters": structure.lattice.abc[0],
                "b_parameters": structure.lattice.abc[1],
                "c_parameters": structure.lattice.abc[2],
                "alpha_parameters": structure.lattice.angles[0],
                "beta_parameters": structure.lattice.angles[1],
                "gamma_parameters": structure.lattice.angles[2],
                "mean_distance_matrix": np.mean(structure.distance_matrix),
                "max_distance_matrix": np.max(structure.distance_matrix),
                "min_distance_matrix": np.min(structure.distance_matrix),
                "std_distance_matrix": np.std(structure.distance_matrix),
            }
        except Exception as e:
            log_message(f"Error extracting features: {e}")
            return None

    data = []
    log_message("Extracting features...")

    for r in results:
        try:
            structure = r.structure
            band_gap = r.band_gap
            formula = structure.composition.reduced_formula
            features = extract_features_from_structure(structure)
            if features and band_gap is not None:
                data.append([formula] + list(features.values()) + [band_gap])
        except Exception as e:
            log_message(f"Error processing material: {e}\n{traceback.format_exc()}")

    feature_columns = list(extract_features_from_structure(results[0].structure).keys())
    columns = ["Formula"] + feature_columns + ["Band Gap"]
    dataset_df = pd.DataFrame(data, columns=columns)

    dataset_df.to_csv("band_gap_dataset.csv", index=False)
    log_message("Dataset saved as 'band_gap_dataset.csv'")

    # Step 3: Train Model on All Materials
    log_message("Training Linear Regression model on all materials...")
    X = dataset_df.drop(columns=["Formula", "Band Gap"])
    y = dataset_df["Band Gap"]

    scaler = StandardScaler().fit(X)
    X_scaled = scaler.transform(X)

    X_train, X_test, y_train, y_test = train_test_split(X_scaled, y, test_size=0.2, random_state=42)

    model = LinearRegression()
    model.fit(X_train, y_train)
    y_pred = model.predict(X_test)

    # Step 4: Save Predictions and Plot
    output_df = pd.DataFrame({"True Band Gap": y_test, "Predicted Band Gap": y_pred})
    output_df.to_csv("all_materials_predictions.csv", index=False)

    plt.figure(figsize=(8, 6))
    sns.scatterplot(x=y_test, y=y_pred)
    plt.xlabel("True Band Gap")
    plt.ylabel("Predicted Band Gap")
    plt.title("Prediction vs True Band Gap (All Materials)")
    plt.savefig("all_materials_plot.png")
    log_message("Saved all materials plot.")

    # Step 5: Filter Only Oxygen-Containing Compounds
    log_message("Filtering oxygen-containing compounds...")
    dataset_O = dataset_df[dataset_df["Formula"].str.contains("O")]
    dataset_O.to_csv("oxygen_filtered_dataset.csv", index=False)

    # Step 6: Retrain Model for Oxygen-Containing Compounds
    log_message("Training model on oxygen-containing compounds...")
    X_O = dataset_O.drop(columns=["Formula", "Band Gap"])
    y_O = dataset_O["Band Gap"]

    scaler_O = StandardScaler().fit(X_O)
    X_O_scaled = scaler_O.transform(X_O)
    X_train_O, X_test_O, y_train_O, y_test_O = train_test_split(X_O_scaled, y_O, test_size=0.2, random_state=42)

    model_O = LinearRegression()
    model_O.fit(X_train_O, y_train_O)
    y_pred_O = model_O.predict(X_test_O)

    # Evaluation: All Materials
    model_name = "Linear Regression (All Materials)"
    mse = mean_squared_error(y_test, y_pred)
    r2 = r2_score(y_test, y_pred)
    rmse = np.sqrt(mse)
    print(f"{model_name} - MSE: {mse:.5f}, R²: {r2:.5f}, RMSE: {rmse:.5f}")

    # Evaluation: Oxygen-Only
    model_name_O = "Linear Regression (Oxygen Compounds)"
    mse_O = mean_squared_error(y_test_O, y_pred_O)
    r2_O = r2_score(y_test_O, y_pred_O)
    rmse_O = np.sqrt(mse_O)
    print(f"{model_name_O} - MSE: {mse_O:.5f}, R²: {r2_O:.5f}, RMSE: {rmse_O:.5f}")

    # Save Predictions and Plot
    output_O_df = pd.DataFrame({"True Band Gap": y_test_O, "Predicted Band Gap": y_pred_O})
    output_O_df.to_csv("oxygen_filtered_predictions.csv", index=False)

    plt.figure(figsize=(8, 6))
    sns.scatterplot(x=y_test_O, y=y_pred_O)
    plt.xlabel("True Band Gap")
    plt.ylabel("Predicted Band Gap")
    plt.title("Prediction vs True Band Gap (Oxygen-Containing Compounds)")
    plt.savefig("oxygen_filtered_plot.png")
    log_message("Saved oxygen-filtered materials plot.")

    # Step 7: Predict Band Gap for Given Structure
    log_message("Predicting band gap for a given material...")
    poscar_structure = Structure.from_str(
        """
1.0
        3.7127823810        -2.1435759056         0.0000000000
       -0.0000000013         4.2871518135         0.0000000000
        0.0000000000         0.0000000000        15.0000000000
    K    O
    2    1
Direct
     0.333333334         0.666666611         0.564284960
     0.666666603         0.333333320         0.435715008
     0.000000000         0.000000000         0.500000000""", fmt="poscar"
     )

    poscar_features = extract_features_from_structure(poscar_structure)
    if poscar_features:
        poscar_features_df = pd.DataFrame([poscar_features], columns=X_O.columns)
        poscar_features_scaled = scaler_O.transform(poscar_features_df)
        poscar_band_gap_prediction = model_O.predict(poscar_features_scaled)
        log_message(f"Predicted Band Gap for given material: {poscar_band_gap_prediction[0]:.3f} eV")

        with open("given_material_band_gap.txt", "w") as f:
            f.write(f"Predicted Band Gap: {poscar_band_gap_prediction[0]:.3f} eV\n")
        log_message("Predicted band gap saved to 'given_material_band_gap.txt'")

        plt.figure(figsize=(6, 4))
        plt.bar(["Predicted Band Gap"], [poscar_band_gap_prediction[0]], color='blue')
        plt.ylabel("Band Gap (eV)")
        plt.title("Predicted Band Gap of the material")
        plt.savefig("Band_plot.png")
        log_message("Saved Band plot.")
    else:
        log_message("Feature extraction failed for the given material.")

    log_message("Process completed.")

except Exception as e:
    log_message(f"Unexpected error: {e}\n{traceback.format_exc()}")
